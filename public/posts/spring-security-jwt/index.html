<!DOCTYPE html>
<html lang="zh-TW" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>「Spring Security」整合 JWT 实现无状态登录示例 | My New Hugo Site！！！</title>

    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>


</head>
<body class="baseof">
  <header>
    <h1>My New Hugo Site！！！</h1>

  <nav>
    <ul>
    <li>
      <a href="/">首页</a>
    </li>
    <li>
      <a aria-current="true" class="ancestor" href="/posts/">列表</a>
    </li>
    <li>
      <a href="/tags/">标签</a>
    </li>
    </ul>
  </nav>


  </header>
  <main>
    
  <h1>最新文章 测试Single：「Spring Security」整合 JWT 实现无状态登录示例</h1>

  
  
  <time datetime="2021-12-09T16:35:00&#43;00:00">December 9, 2021</time>

  <p>JSON Web Token（缩写 JWT）基于JSON格式信息一种Token令牌，是目前最流行的跨域认证解决方案。</p>
<!-- raw HTML omitted -->
<ul>
<li>JWT 的原理是，服务器认证以后，生成一个 JSON 对象，发回给用户。</li>
<li>此后，用户与服务端通信的时候，都要发回这个 JSON 对象。服务器完全只靠这个对象认定用户身份。为了防止用户篡改数据，服务器在生成这个对象的时候，会加上签名。</li>
<li>服务器就不保存任何 session 数据了，也就是说，服务器变成无状态了，从而比较容易实现扩展。</li>
</ul>
<h3 id="1-依赖与配置文件">1. 依赖与配置文件</h3>
<ol>
<li>在 <code>pom.xml</code> 中引入依赖：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-security<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-web<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.mybatis.spring.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>mybatis-spring-boot-starter<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>2.2.0<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>mysql<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>mysql-connector-java<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;scope&gt;</span>runtime<span style="color:#f92672">&lt;/scope&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.projectlombok<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>lombok<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;optional&gt;</span>true<span style="color:#f92672">&lt;/optional&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>io.jsonwebtoken<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>jjwt<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>0.9.1<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>com.alibaba<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>fastjson<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;version&gt;</span>1.2.78<span style="color:#f92672">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>用户信息从数据库中获取，在 <code>application.yml</code> 配置文件中配置：</li>
</ol>
<pre tabindex="0"><code class="language-ymal" data-lang="ymal">server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://192.168.2.100:3306/security?characterEncoding=UTF8&amp;serverTimezone=Asia/Shanghai
    username: developer
    password: 05bZ/OxTB:X+yd%1

mybatis:
  mapper-locations: classpath:mapper/*.xml
</code></pre><h3 id="2-自定义security策略">2. 自定义Security策略</h3>
<h4 id="21-通过继承-websecurityconfigureradapter-实现自定义security策略">2.1 通过继承 WebSecurityConfigurerAdapter 实现自定义Security策略</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 1. 通过继承 WebSecurityConfigurerAdapter 实现自定义Security策略
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @Configuration：声明当前类是一个配置类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @EnableWebSecurity：开启WebSecurity模式
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * @EnableGlobalMethodSecurity(securedEnabled=true)：开启注解，支持方法级别的权限控制
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableGlobalMethodSecurity</span>(securedEnabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserDetailsService userDetailsService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> BCryptPasswordEncoder bCryptPasswordEncoder;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 全局请求忽略规则配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span>(WebSecurity web) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 需要放行的URL</span>
</span></span><span style="display:flex;"><span>        web.<span style="color:#a6e22e">ignoring</span>().<span style="color:#a6e22e">antMatchers</span>(<span style="color:#e6db74">&#34;/register&#34;</span>, <span style="color:#e6db74">&#34;/hello&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 自定义认证策略：登录的时候会进入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span>(AuthenticationManagerBuilder auth) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2.通过实现 AuthenticationProvider 自定义身份认证验证组件</span>
</span></span><span style="display:flex;"><span>        auth.<span style="color:#a6e22e">authenticationProvider</span>(<span style="color:#66d9ef">new</span> AuthenticationProviderImpl(userDetailsService, bCryptPasswordEncoder));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * HTTP 验证规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span>(HttpSecurity http) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        http
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 关闭Session</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">sessionManagement</span>().<span style="color:#a6e22e">sessionCreationPolicy</span>(SessionCreationPolicy.<span style="color:#a6e22e">STATELESS</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 所有请求需要身份认证</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>().<span style="color:#a6e22e">authorizeRequests</span>().<span style="color:#a6e22e">anyRequest</span>().<span style="color:#a6e22e">authenticated</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 3.自定义JWT登录过滤器</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">addFilter</span>(<span style="color:#66d9ef">new</span> JwtLoginFilter(authenticationManager()))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 4.自定义JWT认证过滤器</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">addFilter</span>(<span style="color:#66d9ef">new</span> JwtAuthenticationFilter(authenticationManager()))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 5.自定义认证拦截器，也可以直接使用内置实现类Http403ForbiddenEntryPoint</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">exceptionHandling</span>().<span style="color:#a6e22e">authenticationEntryPoint</span>(<span style="color:#66d9ef">new</span> AuthenticationEntryPointImpl())
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 允许跨域</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>().<span style="color:#a6e22e">cors</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 禁用跨站伪造</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>().<span style="color:#a6e22e">csrf</span>().<span style="color:#a6e22e">disable</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p><code>BCryptPasswordEncoder</code> 解析器注入到容器</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WebConfig</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Bean</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> BCryptPasswordEncoder <span style="color:#a6e22e">bCryptPasswordEncoder</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> BCryptPasswordEncoder();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>实现 <code>UserDetailsService</code> 接口，自定义逻辑</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UserDetailsServiceImpl</span> <span style="color:#66d9ef">implements</span> UserDetailsService {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> SysUserDao sysUserDao;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> UserDetails <span style="color:#a6e22e">loadUserByUsername</span>(String username) <span style="color:#66d9ef">throws</span> UsernameNotFoundException {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 数据库中查找用户</span>
</span></span><span style="display:flex;"><span>        SysUser user <span style="color:#f92672">=</span> sysUserDao.<span style="color:#a6e22e">findByUsername</span>(username);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span>(user <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span>){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> UsernameNotFoundException(<span style="color:#e6db74">&#34;用户&#34;</span> <span style="color:#f92672">+</span> username <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;不存在!&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> User(user.<span style="color:#a6e22e">getUsername</span>(), user.<span style="color:#a6e22e">getPassword</span>(), emptyList());
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="22-通过实现-authenticationprovider-自定义身份认证验证组件">2.2 通过实现 AuthenticationProvider 自定义身份认证验证组件</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationProviderImpl</span> <span style="color:#66d9ef">implements</span> AuthenticationProvider {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> UserDetailsService userDetailsService;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> BCryptPasswordEncoder bCryptPasswordEncoder;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AuthenticationProviderImpl</span>(UserDetailsService userDetailsService, BCryptPasswordEncoder bCryptPasswordEncoder){
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">userDetailsService</span> <span style="color:#f92672">=</span> userDetailsService;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">bCryptPasswordEncoder</span> <span style="color:#f92672">=</span> bCryptPasswordEncoder;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 用来验证用户身份 （对传递的Authentication对象的身份验证）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     *
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param authentication 传递的Authentication对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return 包含凭证的经过完全认证的对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @throws AuthenticationException 份验证失败异常
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">authenticate</span>(Authentication authentication) <span style="color:#66d9ef">throws</span> AuthenticationException {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 获取认证的用户名 &amp; 密码</span>
</span></span><span style="display:flex;"><span>        String name <span style="color:#f92672">=</span> authentication.<span style="color:#a6e22e">getName</span>();
</span></span><span style="display:flex;"><span>        String password <span style="color:#f92672">=</span> authentication.<span style="color:#a6e22e">getCredentials</span>().<span style="color:#a6e22e">toString</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 认证逻辑</span>
</span></span><span style="display:flex;"><span>        UserDetails userDetails <span style="color:#f92672">=</span> userDetailsService.<span style="color:#a6e22e">loadUserByUsername</span>(name);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (bCryptPasswordEncoder.<span style="color:#a6e22e">matches</span>(password, userDetails.<span style="color:#a6e22e">getPassword</span>())) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;用户登录成功，username={}&#34;</span>, name);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 这里设置权限和角色</span>
</span></span><span style="display:flex;"><span>            ArrayList<span style="color:#f92672">&lt;</span>GrantedAuthority<span style="color:#f92672">&gt;</span> authorities <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>            authorities.<span style="color:#a6e22e">add</span>( <span style="color:#66d9ef">new</span> GrantedAuthorityImpl(<span style="color:#e6db74">&#34;ROLE_ADMIN&#34;</span>));
</span></span><span style="display:flex;"><span>            authorities.<span style="color:#a6e22e">add</span>( <span style="color:#66d9ef">new</span> GrantedAuthorityImpl(<span style="color:#e6db74">&#34;AUTH_WRITE&#34;</span>));
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 生成令牌 这里令牌里面存入了:name,password,authorities, 当然你也可以放其他内容</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken(name, password, authorities);
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> BadCredentialsException(<span style="color:#e6db74">&#34;密码错误&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 判断当前的AuthenticationProvider 是否支持对应的Authentication对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param authentication Authentication对象
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @return boolean
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">supports</span>(Class<span style="color:#f92672">&lt;?&gt;</span> authentication) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> authentication.<span style="color:#a6e22e">equals</span>(UsernamePasswordAuthenticationToken.<span style="color:#a6e22e">class</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>实现 <code>GrantedAuthority</code> 存储权限和角色</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 权限类型，负责存储权限和角色
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">GrantedAuthorityImpl</span> <span style="color:#66d9ef">implements</span> GrantedAuthority {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String authority;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">GrantedAuthorityImpl</span>(String authority) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authority</span> <span style="color:#f92672">=</span> authority;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">setAuthority</span>(String authority) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authority</span> <span style="color:#f92672">=</span> authority;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">getAuthority</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authority</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="23-自定义jwt登录过滤器继承-usernamepasswordauthenticationfilter">2.3 自定义JWT登录过滤器，继承 UsernamePasswordAuthenticationFilter</h4>
<p>重写了其中的3个方法</p>
<ul>
<li><code>attemptAuthentication</code>：接收并解析用户凭证。</li>
<li><code>successfulAuthentication</code>：用户成功登录后被调用，我们在这个方法里生成token。</li>
<li><code>unsuccessfulAuthentication</code>：认证失败后被调用</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JwtLoginFilter</span> <span style="color:#66d9ef">extends</span> UsernamePasswordAuthenticationFilter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AuthenticationManager authenticationManager;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">JwtLoginFilter</span>(AuthenticationManager authenticationManager) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authenticationManager</span> <span style="color:#f92672">=</span> authenticationManager;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 尝试身份认证(接收并解析用户凭证)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">attemptAuthentication</span>(HttpServletRequest request, HttpServletResponse response) <span style="color:#66d9ef">throws</span> AuthenticationException {
</span></span><span style="display:flex;"><span>        String username <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getParameter</span>(<span style="color:#e6db74">&#34;username&#34;</span>);
</span></span><span style="display:flex;"><span>        String password <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getParameter</span>(<span style="color:#e6db74">&#34;password&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> authenticationManager.<span style="color:#a6e22e">authenticate</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken(username, password, <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>())
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 认证成功(用户成功登录后，这个方法会被调用，我们在这个方法里生成token)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">successfulAuthentication</span>(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication auth) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Collection<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> GrantedAuthority<span style="color:#f92672">&gt;</span> authorities <span style="color:#f92672">=</span> auth.<span style="color:#a6e22e">getAuthorities</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 定义存放角色集合的对象</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> roleList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (GrantedAuthority grantedAuthority : authorities) {
</span></span><span style="display:flex;"><span>                roleList.<span style="color:#a6e22e">add</span>(grantedAuthority.<span style="color:#a6e22e">getAuthority</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 生成token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             */</span>
</span></span><span style="display:flex;"><span>            Calendar calendar <span style="color:#f92672">=</span> Calendar.<span style="color:#a6e22e">getInstance</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置签发时间</span>
</span></span><span style="display:flex;"><span>            calendar.<span style="color:#a6e22e">setTime</span>(<span style="color:#66d9ef">new</span> Date());
</span></span><span style="display:flex;"><span>            Date now <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置过期时间: 5分钟</span>
</span></span><span style="display:flex;"><span>            calendar.<span style="color:#a6e22e">add</span>(Calendar.<span style="color:#a6e22e">MINUTE</span>, 5);
</span></span><span style="display:flex;"><span>            Date time <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>            String token <span style="color:#f92672">=</span> Jwts.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setSubject</span>(auth.<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">+</span> roleList)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 签发时间</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setIssuedAt</span>(now)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 过期时间</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setExpiration</span>(time)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 自定义算法与签名：这里算法采用HS512，常量中定义签名key</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">signWith</span>(SignatureAlgorithm.<span style="color:#a6e22e">HS512</span>, ConstantKey.<span style="color:#a6e22e">SIGNING_KEY</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">compact</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 返回token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             */</span>
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;用户登录成功，生成token={}&#34;</span>, token);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 登录成功后，返回token到header里面</span>
</span></span><span style="display:flex;"><span>            response.<span style="color:#a6e22e">addHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>, token);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 登录成功后，返回token到body里面</span>
</span></span><span style="display:flex;"><span>            ResponseJson<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> ResponseJson.<span style="color:#a6e22e">success</span>(token);
</span></span><span style="display:flex;"><span>            response.<span style="color:#a6e22e">setCharacterEncoding</span>(<span style="color:#e6db74">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>            response.<span style="color:#a6e22e">getWriter</span>().<span style="color:#a6e22e">write</span>(JSON.<span style="color:#a6e22e">toJSONString</span>(result));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;IOException:&#34;</span>, e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 认证失败调用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unsuccessfulAuthentication</span>(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;登录失败[{}]，AuthenticationException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), exception.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 登录失败，返回错误信息</span>
</span></span><span style="display:flex;"><span>        ResponseJson<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> ResponseJson.<span style="color:#a6e22e">error</span>(exception.<span style="color:#a6e22e">getMessage</span>(), <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">setCharacterEncoding</span>(<span style="color:#e6db74">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">getWriter</span>().<span style="color:#a6e22e">write</span>(JSON.<span style="color:#a6e22e">toJSONString</span>(result));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>自定义加密的签名<code>key</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 自定义签名key常量
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConstantKey</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> String SIGNING_KEY <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Charles@Jwt!&amp;Secret^#&#34;</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>自定义全局API返回JSON数据对象</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ResponseJson</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#66d9ef">implements</span> Serializable {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** 自定义状态码 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">int</span> code;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** 提示信息 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String msg;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/** 返回数据 */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> T data;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">ResponseJson</span>(<span style="color:#66d9ef">int</span> code, String msg, T data) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">code</span> <span style="color:#f92672">=</span> code;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">msg</span> <span style="color:#f92672">=</span> msg;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">data</span> <span style="color:#f92672">=</span> data;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ResponseJson<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">success</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(0, <span style="color:#e6db74">&#34;操作成功&#34;</span>, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> ResponseJson<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">success</span>(T data) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(0, <span style="color:#e6db74">&#34;操作成功&#34;</span>, data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> ResponseJson<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">success</span>(String msg, T data) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(0, msg, data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> ResponseJson<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">success</span>(<span style="color:#66d9ef">int</span> code, String msg, T data) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(code, msg, data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ResponseJson<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">error</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(<span style="color:#f92672">-</span>1, <span style="color:#e6db74">&#34;操作失败&#34;</span>, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ResponseJson<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">error</span>(String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(<span style="color:#f92672">-</span>1, msg, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> ResponseJson<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">error</span>(<span style="color:#66d9ef">int</span> code, String msg) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(code, msg, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> ResponseJson<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">error</span>(String msg, T data) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(<span style="color:#f92672">-</span>1, msg, data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span><span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> ResponseJson<span style="color:#f92672">&lt;</span>T<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">error</span>(<span style="color:#66d9ef">int</span> code, String msg, T data) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> ResponseJson<span style="color:#f92672">&lt;&gt;</span>(code, msg, data);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> String <span style="color:#a6e22e">toString</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#34;ResponseJson{&#34;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;code=&#34;</span> <span style="color:#f92672">+</span> code <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, msg=&#39;&#34;</span> <span style="color:#f92672">+</span> msg <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;\&#39;&#39;</span> <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;, data=&#34;</span> <span style="color:#f92672">+</span> data <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;}&#39;</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">long</span> serialVersionUID <span style="color:#f92672">=</span> 1L;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="24-自定义jwt认证过滤器继承-basicauthenticationfilter重写dofilterinternal方法">2.4 自定义JWT认证过滤器，继承 BasicAuthenticationFilter，重写doFilterInternal方法</h4>
<p>从http头的Authorization 项读取token数据，然后用Jwts包提供的方法校验token的合法性。如果校验通过，就认为这是一个取得授权的合法请求。</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JwtAuthenticationFilter</span> <span style="color:#66d9ef">extends</span> BasicAuthenticationFilter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">JwtAuthenticationFilter</span>(AuthenticationManager authenticationManager) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>(authenticationManager);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilterInternal</span>(HttpServletRequest request, HttpServletResponse response, FilterChain chain) <span style="color:#66d9ef">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        UsernamePasswordAuthenticationToken authentication <span style="color:#f92672">=</span> getAuthentication(request, response);
</span></span><span style="display:flex;"><span>        SecurityContextHolder.<span style="color:#a6e22e">getContext</span>().<span style="color:#a6e22e">setAuthentication</span>(authentication);
</span></span><span style="display:flex;"><span>        chain.<span style="color:#a6e22e">doFilter</span>(request, response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UsernamePasswordAuthenticationToken <span style="color:#a6e22e">getAuthentication</span>(HttpServletRequest request, HttpServletResponse response) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 解析token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        String token <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>ObjectUtils.<span style="color:#a6e22e">isEmpty</span>(token)) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                Claims claims <span style="color:#f92672">=</span> Jwts.<span style="color:#a6e22e">parser</span>()
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 设置生成token的签名key</span>
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">setSigningKey</span>(ConstantKey.<span style="color:#a6e22e">SIGNING_KEY</span>)
</span></span><span style="display:flex;"><span>                        <span style="color:#75715e">// 解析token</span>
</span></span><span style="display:flex;"><span>                        .<span style="color:#a6e22e">parseClaimsJws</span>(token).<span style="color:#a6e22e">getBody</span>();
</span></span><span style="display:flex;"><span>                String user <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getSubject</span>();
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (user <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    String<span style="color:#f92672">[]</span> split <span style="color:#f92672">=</span> user.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;-&#34;</span>)<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>                    ArrayList<span style="color:#f92672">&lt;</span>GrantedAuthority<span style="color:#f92672">&gt;</span> authorities <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> (String s : split) {
</span></span><span style="display:flex;"><span>                        authorities.<span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">new</span> GrantedAuthorityImpl(s));
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 刷新Token</span>
</span></span><span style="display:flex;"><span>                    refreshToken(response, claims);
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 返回Authentication</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken(user, <span style="color:#66d9ef">null</span>, authorities);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (ExpiredJwtException e) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，ExpiredJwtException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (UnsupportedJwtException e) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，UnsupportedJwtException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (MalformedJwtException e) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，MalformedJwtException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (SignatureException e) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，SignatureException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>            } <span style="color:#66d9ef">catch</span> (IllegalArgumentException e) {
</span></span><span style="display:flex;"><span>                log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，IllegalArgumentException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，需要身份认证&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 刷新Token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 刷新Token的时机：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 1. 当前时间 &lt; token过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 2. 当前时间 &gt; (签发时间 + (token过期时间 - token签发时间)/2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">refreshToken</span>(HttpServletResponse response, Claims claims) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 当前时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> current <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// token签发时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> issuedAt <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getIssuedAt</span>().<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// token过期时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> expiration <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getExpiration</span>().<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// (当前时间 &lt; token过期时间) &amp;&amp; (当前时间 &gt; (签发时间 + (token过期时间 - token签发时间)/2))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> ((current <span style="color:#f92672">&lt;</span> expiration) <span style="color:#f92672">&amp;&amp;</span> (current <span style="color:#f92672">&gt;</span> (issuedAt <span style="color:#f92672">+</span> ((expiration <span style="color:#f92672">-</span> issuedAt) <span style="color:#f92672">/</span> 2)))) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 重新生成token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             */</span>
</span></span><span style="display:flex;"><span>            Calendar calendar <span style="color:#f92672">=</span> Calendar.<span style="color:#a6e22e">getInstance</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置签发时间</span>
</span></span><span style="display:flex;"><span>            calendar.<span style="color:#a6e22e">setTime</span>(<span style="color:#66d9ef">new</span> Date());
</span></span><span style="display:flex;"><span>            Date now <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置过期时间: 5分钟</span>
</span></span><span style="display:flex;"><span>            calendar.<span style="color:#a6e22e">add</span>(Calendar.<span style="color:#a6e22e">MINUTE</span>, 5);
</span></span><span style="display:flex;"><span>            Date time <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>            String refreshToken <span style="color:#f92672">=</span> Jwts.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setSubject</span>(claims.<span style="color:#a6e22e">getSubject</span>())
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 签发时间</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setIssuedAt</span>(now)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 过期时间</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setExpiration</span>(time)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 算法与签名(同生成token)：这里算法采用HS512，常量中定义签名key</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">signWith</span>(SignatureAlgorithm.<span style="color:#a6e22e">HS512</span>, ConstantKey.<span style="color:#a6e22e">SIGNING_KEY</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">compact</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 主动刷新token，并返回给前端</span>
</span></span><span style="display:flex;"><span>            response.<span style="color:#a6e22e">addHeader</span>(<span style="color:#e6db74">&#34;refreshToken&#34;</span>, refreshToken);
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;刷新token执行时间: {}&#34;</span>, (System.<span style="color:#a6e22e">currentTimeMillis</span>() <span style="color:#f92672">-</span> current) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 毫秒&#34;</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h4 id="25-通过实现-authenticationentrypoint-自定义认证拦截器">2.5 通过实现 <code>AuthenticationEntryPoint</code> 自定义认证拦截器</h4>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">AuthenticationEntryPointImpl</span> <span style="color:#66d9ef">implements</span> AuthenticationEntryPoint {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">AuthenticationEntryPointImpl</span>() {}
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param request 遇到了认证异常authException用户请求
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * @param response 将要返回给客户的相应
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">commence</span>(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">debug</span>(<span style="color:#e6db74">&#34;预认证入口被调用。拒绝访问，AuthenticationException={}&#34;</span>, exception.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 没有权限，返回403</span>
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">sendError</span>(403, <span style="color:#e6db74">&#34;Access Denied&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h3 id="3-示例demo">3. 示例DEMO</h3>
<p>sql</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">DROP</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#66d9ef">IF</span> <span style="color:#66d9ef">EXISTS</span> <span style="color:#f92672">`</span>sys_user<span style="color:#f92672">`</span>;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#f92672">`</span>sys_user<span style="color:#f92672">`</span> (
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>id<span style="color:#f92672">`</span> bigint <span style="color:#66d9ef">NOT</span> <span style="color:#66d9ef">NULL</span> AUTO_INCREMENT,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>username<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;用户名&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">`</span>password<span style="color:#f92672">`</span> varchar(<span style="color:#ae81ff">255</span>) <span style="color:#66d9ef">DEFAULT</span> <span style="color:#66d9ef">NULL</span> <span style="color:#66d9ef">COMMENT</span> <span style="color:#e6db74">&#39;密码&#39;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span> (<span style="color:#f92672">`</span>id<span style="color:#f92672">`</span>)
</span></span><span style="display:flex;"><span>) ENGINE<span style="color:#f92672">=</span>InnoDB <span style="color:#66d9ef">DEFAULT</span> CHARSET<span style="color:#f92672">=</span>utf8 <span style="color:#66d9ef">COMMENT</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;系统用户表&#39;</span>;
</span></span></code></pre></div><p>Java代码</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 接口
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@RestController</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SysUserApi</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> SysUserService sysUserService;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@PostMapping</span>(<span style="color:#e6db74">&#34;/register&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseJson<span style="color:#f92672">&lt;</span>SysUser<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">register</span>(SysUser sysUser) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> sysUserService.<span style="color:#a6e22e">register</span>(sysUser);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span>(<span style="color:#e6db74">&#34;/hello&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseJson<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">hello</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ResponseJson.<span style="color:#a6e22e">success</span>(<span style="color:#e6db74">&#34;访问成功！公开接口：/hello&#34;</span>,<span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@GetMapping</span>(<span style="color:#e6db74">&#34;/private&#34;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseJson<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">hello2</span>() {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ResponseJson.<span style="color:#a6e22e">success</span>(<span style="color:#e6db74">&#34;访问成功！非公开接口：/private&#34;</span>, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 用户实体类
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Data</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SysUser</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> Long id;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String username;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> String password;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 服务层
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SysUserService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> SysUserDao sysUserDao;
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> BCryptPasswordEncoder passwordEncoder;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> ResponseJson<span style="color:#f92672">&lt;</span>SysUser<span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">register</span>(SysUser sysUser) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">isEmpty</span>(sysUser.<span style="color:#a6e22e">getUsername</span>()) <span style="color:#f92672">||</span> StringUtils.<span style="color:#a6e22e">isEmpty</span>(sysUser.<span style="color:#a6e22e">getPassword</span>())){
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> ResponseJson.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;用户名或密码不能为空&#34;</span>, <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        String encodePassword <span style="color:#f92672">=</span> passwordEncoder.<span style="color:#a6e22e">encode</span>(sysUser.<span style="color:#a6e22e">getPassword</span>());
</span></span><span style="display:flex;"><span>        sysUser.<span style="color:#a6e22e">setPassword</span>(encodePassword);
</span></span><span style="display:flex;"><span>        sysUserDao.<span style="color:#a6e22e">insertSysUser</span>(sysUser);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> ResponseJson.<span style="color:#a6e22e">success</span>(<span style="color:#e6db74">&#34;注册成功&#34;</span>, sysUser);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * DAO层
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@Mapper</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">interface</span> <span style="color:#a6e22e">SysUserDao</span> {
</span></span><span style="display:flex;"><span>    SysUser <span style="color:#a6e22e">findByUsername</span>(String username);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">insertSysUser</span>(SysUser sysUser);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;insert</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;insertSysUser&#34;</span> <span style="color:#a6e22e">keyProperty=</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#a6e22e">keyColumn=</span><span style="color:#e6db74">&#34;id&#34;</span> <span style="color:#a6e22e">useGeneratedKeys=</span><span style="color:#e6db74">&#34;true&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>INSERT INTO sys_user(username, password) VALUES(#{username}, #{password})
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/insert&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;select</span> <span style="color:#a6e22e">id=</span><span style="color:#e6db74">&#34;findByUsername&#34;</span> <span style="color:#a6e22e">resultType=</span><span style="color:#e6db74">&#34;com.example.jwt.entity.SysUser&#34;</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>SELECT id,username,PASSWORD FROM sys_user WHERE username=#{username}
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/select&gt;</span>
</span></span></code></pre></div><h3 id="4-测试">4. 测试</h3>
<p>注册一个用户：</p>
<p><img src="up-370de8ce7710b876dfd137c959fa7eee380.webp" alt=""></p>
<p>登录，返回Token：</p>
<p><img src="up-1fef936e1e165efa73d6b133eba887c9d6d.webp" alt=""></p>
<p>访问公开接口：</p>
<p><img src="up-f342a930a199bcca09e0866b790c3a6a2db.webp" alt=""></p>
<p>访问需要认证的接口，无权限返回403：</p>
<p><img src="up-13ffbcfb34a1c5d879d1e2b2a0c883fb204.webp" alt=""></p>
<p>访问需要认证的接口，通过有效Token访问：</p>
<p><img src="up-c5efb32d07d1bd147f8c3dae689cde5eda6.webp" alt=""></p>
<blockquote>
<p>源码地址：<a href="https://github.com/chaooo/spring-security-jwt.git">https://github.com/chaooo/spring-security-jwt.git</a>,
这里我将本文的登录认证逻辑放在github源码tag的V1.0中，防止后续修改后对不上。</p>
</blockquote>

  
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></li>
        <li><a href="/tags/springsecurity/">SpringSecurity</a></li>
        <li><a href="/tags/%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81/">安全认证</a></li>
        <li><a href="/tags/jwt/">JWT</a></li>
    </ul>
  </div>


  </main>
  <footer>
    <p>Copyright 2024. All rights reserved.</p>

  </footer>
</body>
</html>
