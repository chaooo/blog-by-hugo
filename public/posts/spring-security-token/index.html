<!DOCTYPE html>
<html lang="zh-TW" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>「Spring Security」基于Redis的Token自动续签优化 | My New Hugo Site！！！</title>

    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>


</head>
<body class="baseof">
  <header>
    <h1>My New Hugo Site！！！</h1>

  <nav>
    <ul>
    <li>
      <a href="/">首页</a>
    </li>
    <li>
      <a aria-current="true" class="ancestor" href="/posts/">列表</a>
    </li>
    <li>
      <a href="/tags/">标签</a>
    </li>
    </ul>
  </nav>


  </header>
  <main>
    
  <h1>最新文章 测试Single：「Spring Security」基于Redis的Token自动续签优化</h1>

  
  
  <time datetime="2021-12-10T11:35:00&#43;00:00">December 10, 2021</time>

  <p>本文基于上一篇文章：《Spring Security（三）整合 JWT 实现无状态登录示例》。</p>
<p>在 <code>SpringSecurity</code> 整合 <code>JWT</code> 实现无状态登录示例中，我们在 <code>JwtAuthenticationFilter</code> (自定义<code>JWT</code>认证过滤器) 解析 <code>Token</code> 成功后，提供了续签逻辑：<!-- raw HTML omitted --></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 刷新Token的时机：
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 1. 当前时间 &lt; token过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * 2. 当前时间 &gt; (签发时间 + (token过期时间 - token签发时间)/2)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">refreshToken</span>(HttpServletResponse response, Claims claims) {
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// 当前时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> current <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// token签发时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> issuedAt <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getIssuedAt</span>().<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// token过期时间</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">long</span> expiration <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getExpiration</span>().<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// (当前时间 &lt; token过期时间) &amp;&amp; (当前时间 &gt; (签发时间 + (token过期时间 - token签发时间)/2))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> ((current <span style="color:#f92672">&lt;</span> expiration) <span style="color:#f92672">&amp;&amp;</span> (current <span style="color:#f92672">&gt;</span> (issuedAt <span style="color:#f92672">+</span> ((expiration <span style="color:#f92672">-</span> issuedAt) <span style="color:#f92672">/</span> 2)))) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 重新生成token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        Calendar calendar <span style="color:#f92672">=</span> Calendar.<span style="color:#a6e22e">getInstance</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置签发时间</span>
</span></span><span style="display:flex;"><span>        calendar.<span style="color:#a6e22e">setTime</span>(<span style="color:#66d9ef">new</span> Date());
</span></span><span style="display:flex;"><span>        Date now <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置过期时间: 5分钟</span>
</span></span><span style="display:flex;"><span>        calendar.<span style="color:#a6e22e">add</span>(Calendar.<span style="color:#a6e22e">MINUTE</span>, 5);
</span></span><span style="display:flex;"><span>        Date time <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>        String refreshToken <span style="color:#f92672">=</span> Jwts.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setSubject</span>(claims.<span style="color:#a6e22e">getSubject</span>())
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 签发时间</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setIssuedAt</span>(now)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 过期时间</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setExpiration</span>(time)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 算法与签名(同生成token)：这里算法采用HS512，常量中定义签名key</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">signWith</span>(SignatureAlgorithm.<span style="color:#a6e22e">HS512</span>, ConstantKey.<span style="color:#a6e22e">SIGNING_KEY</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">compact</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 主动刷新token，并返回给前端</span>
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">addHeader</span>(<span style="color:#e6db74">&#34;refreshToken&#34;</span>, refreshToken);
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;刷新token执行时间: {}&#34;</span>, (System.<span style="color:#a6e22e">currentTimeMillis</span>() <span style="color:#f92672">-</span> current) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 毫秒&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>这里的逻辑是：<code>Token</code> 未过期并且当前时间已经超过 <code>Token</code> 有效时间的一半，重新生成一个 <code>refreshToken</code>，并返回给前端，前端需要用 <code>refreshToken</code> 替换之前旧的 <code>Token</code>。</p>
<h3 id="token续签优化方案">Token续签优化方案</h3>
<p>预期效果：前端不需要手动替换 <code>Token</code>，每次用 <code>Token</code> 请求资源时自动续期。</p>
<p>实现方案：引入 <code>Redis</code>，实现逻辑：</p>
<ol>
<li>登录成功后将 <code>Token</code> 存储到 <code>Redis</code> 里面(k,v都为 <code>Token</code> 的值)，并设置 <code>Redis</code> 过期时间为： <code>Token</code> 过期时间。</li>
<li>用户发起请求时，每次都根据k为<code>Token</code>的键去换取 <code>Redis</code> 的值，这里命名为 <code>cacheToken</code>：
<ul>
<li>当 <code>cacheToken</code> 在有效期内，重设 <code>Redis</code> 过期时间为：当前时间 + (<code>cacheToken</code>过期时间 - <code>cacheToken</code>签发时间)。</li>
<li>当 <code>cacheToken</code> 已过期（<code>Redis</code> 在有效期内），则 <code>JWT</code> 重新生成 <code>Token</code> 并覆盖v值(这时候k、v值不一样了)，然后设置 <code>Redis</code> 过期时间为： <code>cacheToken</code> 过期时间。</li>
<li>若 <code>Redis</code> 也过期，取不到 <code>cacheToken</code>，则拒绝访问或返回错误信息，需要重新登录。</li>
</ul>
</li>
</ol>
<h4 id="具体实现">具体实现</h4>
<h5 id="1-在-pomxml-中引入-redis-依赖">1. 在 <code>pom.xml</code> 中引入 <code>Redis</code> 依赖：</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-starter-data-redis<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><h5 id="2-在-applicationyml-配置文件中配置-redis">2. 在 <code>application.yml</code> 配置文件中配置 <code>Redis</code>：</h5>
<pre tabindex="0"><code class="language-ymal" data-lang="ymal">spring:
  redis:
    host: 127.0.0.1
    port: 6379
    password: 123456
    # Redis数据库索引（默认为0）
    database: 0
    # 连接超时时间（毫秒）
    timeout: 5000
</code></pre><h5 id="3-简单的-redisservice-封装">3. 简单的 <code>RedisService</code> 封装</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Service</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RedisService</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> RedisTemplate<span style="color:#f92672">&lt;</span>Serializable, Object<span style="color:#f92672">&gt;</span> redisTemplate;
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 读取缓存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Object <span style="color:#a6e22e">get</span>(String key) {
</span></span><span style="display:flex;"><span>        ValueOperations<span style="color:#f92672">&lt;</span>Serializable, Object<span style="color:#f92672">&gt;</span> operations <span style="color:#f92672">=</span> redisTemplate.<span style="color:#a6e22e">opsForValue</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> operations.<span style="color:#a6e22e">get</span>(key);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 判断缓存中是否存在
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">exists</span>(String key) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> StringUtils.<span style="color:#a6e22e">hasLength</span>(key) <span style="color:#f92672">&amp;&amp;</span> Boolean.<span style="color:#a6e22e">TRUE</span>.<span style="color:#a6e22e">equals</span>(redisTemplate.<span style="color:#a6e22e">hasKey</span>(key));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 删除缓存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">remove</span>(String key) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (exists(key)) {
</span></span><span style="display:flex;"><span>            redisTemplate.<span style="color:#a6e22e">delete</span>(key);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 写入缓存
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">set</span>(String key, Object value) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            ValueOperations<span style="color:#f92672">&lt;</span>Serializable, Object<span style="color:#f92672">&gt;</span> operations <span style="color:#f92672">=</span> redisTemplate.<span style="color:#a6e22e">opsForValue</span>();
</span></span><span style="display:flex;"><span>            operations.<span style="color:#a6e22e">set</span>(key, value);
</span></span><span style="display:flex;"><span>            result <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 写入缓存 并 加上过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">set</span>(String key, Object value, Date date) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            ValueOperations<span style="color:#f92672">&lt;</span>Serializable, Object<span style="color:#f92672">&gt;</span> operations <span style="color:#f92672">=</span> redisTemplate.<span style="color:#a6e22e">opsForValue</span>();
</span></span><span style="display:flex;"><span>            operations.<span style="color:#a6e22e">set</span>(key, value);
</span></span><span style="display:flex;"><span>            redisTemplate.<span style="color:#a6e22e">expireAt</span>(key, date);
</span></span><span style="display:flex;"><span>            result <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 写入过期时间（毫秒）
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">boolean</span> <span style="color:#a6e22e">expire</span>(String key, Long expireTimeMillis) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">boolean</span> result <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            redisTemplate.<span style="color:#a6e22e">expire</span>(key, expireTimeMillis, TimeUnit.<span style="color:#a6e22e">MILLISECONDS</span>);
</span></span><span style="display:flex;"><span>            result <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (Exception e) {
</span></span><span style="display:flex;"><span>            e.<span style="color:#a6e22e">printStackTrace</span>();
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> result;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="4-修改jwt登录过滤器-jwtloginfilter构造方法中加入-redisservice并生成-token-后存入-redis">4. 修改JWT登录过滤器 <code>JwtLoginFilter</code>，构造方法中加入 <code>RedisService</code>，并生成 <code>Token</code> 后存入 <code>Redis</code>:</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JwtLoginFilter</span> <span style="color:#66d9ef">extends</span> UsernamePasswordAuthenticationFilter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> AuthenticationManager authenticationManager;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> RedisService redisService;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">JwtLoginFilter</span>(AuthenticationManager authenticationManager, RedisService redisService) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">authenticationManager</span> <span style="color:#f92672">=</span> authenticationManager;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">redisService</span> <span style="color:#f92672">=</span> redisService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 尝试身份认证(接收并解析用户凭证)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> Authentication <span style="color:#a6e22e">attemptAuthentication</span>(HttpServletRequest request, HttpServletResponse response) <span style="color:#66d9ef">throws</span> AuthenticationException {
</span></span><span style="display:flex;"><span>        String username <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getParameter</span>(<span style="color:#e6db74">&#34;username&#34;</span>);
</span></span><span style="display:flex;"><span>        String password <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getParameter</span>(<span style="color:#e6db74">&#34;password&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> authenticationManager.<span style="color:#a6e22e">authenticate</span>(
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken(username, password, <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>())
</span></span><span style="display:flex;"><span>        );
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 认证成功(用户成功登录后，这个方法会被调用，我们在这个方法里生成token)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">successfulAuthentication</span>(HttpServletRequest request, HttpServletResponse response, FilterChain chain, Authentication auth) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>            Collection<span style="color:#f92672">&lt;?</span> <span style="color:#66d9ef">extends</span> GrantedAuthority<span style="color:#f92672">&gt;</span> authorities <span style="color:#f92672">=</span> auth.<span style="color:#a6e22e">getAuthorities</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 定义存放角色集合的对象</span>
</span></span><span style="display:flex;"><span>            List<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> roleList <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">for</span> (GrantedAuthority grantedAuthority : authorities) {
</span></span><span style="display:flex;"><span>                roleList.<span style="color:#a6e22e">add</span>(grantedAuthority.<span style="color:#a6e22e">getAuthority</span>());
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 生成token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             */</span>
</span></span><span style="display:flex;"><span>            Calendar calendar <span style="color:#f92672">=</span> Calendar.<span style="color:#a6e22e">getInstance</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置签发时间</span>
</span></span><span style="display:flex;"><span>            calendar.<span style="color:#a6e22e">setTime</span>(<span style="color:#66d9ef">new</span> Date());
</span></span><span style="display:flex;"><span>            Date now <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 设置过期时间: 5分钟</span>
</span></span><span style="display:flex;"><span>            calendar.<span style="color:#a6e22e">add</span>(Calendar.<span style="color:#a6e22e">MINUTE</span>, 5);
</span></span><span style="display:flex;"><span>            Date time <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>            String token <span style="color:#f92672">=</span> Jwts.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setSubject</span>(auth.<span style="color:#a6e22e">getName</span>() <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;-&#34;</span> <span style="color:#f92672">+</span> roleList)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 签发时间</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setIssuedAt</span>(now)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 过期时间</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">setExpiration</span>(time)
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 自定义算法与签名：这里算法采用HS512，常量中定义签名key</span>
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">signWith</span>(SignatureAlgorithm.<span style="color:#a6e22e">HS512</span>, ConstantKey.<span style="color:#a6e22e">SIGNING_KEY</span>)
</span></span><span style="display:flex;"><span>                    .<span style="color:#a6e22e">compact</span>();
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 将token存入redis,并设置超时时间为token过期时间</span>
</span></span><span style="display:flex;"><span>            redisService.<span style="color:#a6e22e">set</span>(token, token, time);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             * 返回token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">             */</span>
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;用户登录成功，生成token={}&#34;</span>, token);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 登录成功后，返回token到header里面</span>
</span></span><span style="display:flex;"><span>            response.<span style="color:#a6e22e">addHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>, token);
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 登录成功后，返回token到body里面</span>
</span></span><span style="display:flex;"><span>            ResponseJson<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> ResponseJson.<span style="color:#a6e22e">success</span>(<span style="color:#e6db74">&#34;登录成功&#34;</span>, token);
</span></span><span style="display:flex;"><span>            response.<span style="color:#a6e22e">setCharacterEncoding</span>(<span style="color:#e6db74">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>            response.<span style="color:#a6e22e">getWriter</span>().<span style="color:#a6e22e">write</span>(JSON.<span style="color:#a6e22e">toJSONString</span>(result));
</span></span><span style="display:flex;"><span>        } <span style="color:#66d9ef">catch</span> (IOException e) {
</span></span><span style="display:flex;"><span>            log.<span style="color:#a6e22e">error</span>(<span style="color:#e6db74">&#34;IOException:&#34;</span>, e);
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 认证失败调用
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">unsuccessfulAuthentication</span>(HttpServletRequest request, HttpServletResponse response, AuthenticationException exception) <span style="color:#66d9ef">throws</span> IOException {
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;登录失败[{}]，AuthenticationException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), exception.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 登录失败，返回错误信息</span>
</span></span><span style="display:flex;"><span>        ResponseJson<span style="color:#f92672">&lt;</span>Void<span style="color:#f92672">&gt;</span> result <span style="color:#f92672">=</span> ResponseJson.<span style="color:#a6e22e">error</span>(exception.<span style="color:#a6e22e">getMessage</span>(), <span style="color:#66d9ef">null</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">setCharacterEncoding</span>(<span style="color:#e6db74">&#34;UTF-8&#34;</span>);
</span></span><span style="display:flex;"><span>        response.<span style="color:#a6e22e">getWriter</span>().<span style="color:#a6e22e">write</span>(JSON.<span style="color:#a6e22e">toJSONString</span>(result));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="5-修改jwt认证过滤器-jwtauthenticationfilter构造方法中加入-redisservice并添加-token-续签逻辑">5. 修改JWT认证过滤器 <code>JwtAuthenticationFilter</code>，构造方法中加入 <code>RedisService</code>，并添加 <code>Token</code> 续签逻辑:</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Slf4j</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">JwtAuthenticationFilter</span> <span style="color:#66d9ef">extends</span> BasicAuthenticationFilter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">final</span> RedisService redisService;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#a6e22e">JwtAuthenticationFilter</span>(AuthenticationManager authenticationManager, RedisService redisService) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">super</span>(authenticationManager);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">redisService</span> <span style="color:#f92672">=</span> redisService;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">doFilterInternal</span>(HttpServletRequest request, HttpServletResponse response, FilterChain chain) <span style="color:#66d9ef">throws</span> IOException, ServletException {
</span></span><span style="display:flex;"><span>        UsernamePasswordAuthenticationToken authentication <span style="color:#f92672">=</span> getAuthentication(request, response);
</span></span><span style="display:flex;"><span>        SecurityContextHolder.<span style="color:#a6e22e">getContext</span>().<span style="color:#a6e22e">setAuthentication</span>(authentication);
</span></span><span style="display:flex;"><span>        chain.<span style="color:#a6e22e">doFilter</span>(request, response);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UsernamePasswordAuthenticationToken <span style="color:#a6e22e">getAuthentication</span>(HttpServletRequest request, HttpServletResponse response) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 解析token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        String token <span style="color:#f92672">=</span> request.<span style="color:#a6e22e">getHeader</span>(<span style="color:#e6db74">&#34;Authorization&#34;</span>);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">hasLength</span>(token)) {
</span></span><span style="display:flex;"><span>            String cacheToken <span style="color:#f92672">=</span> String.<span style="color:#a6e22e">valueOf</span>(redisService.<span style="color:#a6e22e">get</span>(token));
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (StringUtils.<span style="color:#a6e22e">hasLength</span>(token) <span style="color:#f92672">&amp;&amp;</span> <span style="color:#f92672">!</span><span style="color:#e6db74">&#34;null&#34;</span>.<span style="color:#a6e22e">equals</span>(cacheToken)) {
</span></span><span style="display:flex;"><span>                String user <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">try</span> {
</span></span><span style="display:flex;"><span>                    Claims claims <span style="color:#f92672">=</span> Jwts.<span style="color:#a6e22e">parser</span>()
</span></span><span style="display:flex;"><span>                            <span style="color:#75715e">// 设置生成token的签名key</span>
</span></span><span style="display:flex;"><span>                            .<span style="color:#a6e22e">setSigningKey</span>(ConstantKey.<span style="color:#a6e22e">SIGNING_KEY</span>)
</span></span><span style="display:flex;"><span>                            <span style="color:#75715e">// 解析token</span>
</span></span><span style="display:flex;"><span>                            .<span style="color:#a6e22e">parseClaimsJws</span>(cacheToken).<span style="color:#a6e22e">getBody</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 取出用户信息</span>
</span></span><span style="display:flex;"><span>                    user <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getSubject</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 重设Redis超时时间</span>
</span></span><span style="display:flex;"><span>                    resetRedisExpire(token, claims);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (ExpiredJwtException e) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;Token过期续签，ExpiredJwtException={}&#34;</span>, e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>                    Claims claims <span style="color:#f92672">=</span> e.<span style="color:#a6e22e">getClaims</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 取出用户信息</span>
</span></span><span style="display:flex;"><span>                    user <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getSubject</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 刷新Token</span>
</span></span><span style="display:flex;"><span>                    refreshToken(token, claims);
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (UnsupportedJwtException e) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，UnsupportedJwtException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (MalformedJwtException e) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，MalformedJwtException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (SignatureException e) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，SignatureException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>                } <span style="color:#66d9ef">catch</span> (IllegalArgumentException e) {
</span></span><span style="display:flex;"><span>                    log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，IllegalArgumentException={}&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>(), e.<span style="color:#a6e22e">getMessage</span>());
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> (user <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span>) {
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 获取用户权限和角色</span>
</span></span><span style="display:flex;"><span>                    String<span style="color:#f92672">[]</span> split <span style="color:#f92672">=</span> user.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;-&#34;</span>)<span style="color:#f92672">[</span>1<span style="color:#f92672">]</span>.<span style="color:#a6e22e">split</span>(<span style="color:#e6db74">&#34;,&#34;</span>);
</span></span><span style="display:flex;"><span>                    ArrayList<span style="color:#f92672">&lt;</span>GrantedAuthority<span style="color:#f92672">&gt;</span> authorities <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> ArrayList<span style="color:#f92672">&lt;&gt;</span>();
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">for</span> (String s : split) {
</span></span><span style="display:flex;"><span>                        authorities.<span style="color:#a6e22e">add</span>(<span style="color:#66d9ef">new</span> GrantedAuthorityImpl(s));
</span></span><span style="display:flex;"><span>                    }
</span></span><span style="display:flex;"><span>                    <span style="color:#75715e">// 返回Authentication</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> UsernamePasswordAuthenticationToken(user, <span style="color:#66d9ef">null</span>, authorities);
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">warn</span>(<span style="color:#e6db74">&#34;访问[{}]失败，需要身份认证&#34;</span>, request.<span style="color:#a6e22e">getRequestURI</span>());
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">null</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 重设Redis超时时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 当前时间 + (`cacheToken`过期时间 - `cacheToken`签发时间)
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">resetRedisExpire</span>(String token, Claims claims) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 当前时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> current <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// token签发时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> issuedAt <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getIssuedAt</span>().<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// token过期时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> expiration <span style="color:#f92672">=</span> claims.<span style="color:#a6e22e">getExpiration</span>().<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 当前时间 + (`cacheToken`过期时间 - `cacheToken`签发时间)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> expireAt <span style="color:#f92672">=</span> current <span style="color:#f92672">+</span> (expiration <span style="color:#f92672">-</span> issuedAt);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 重设Redis超时时间</span>
</span></span><span style="display:flex;"><span>        redisService.<span style="color:#a6e22e">expire</span>(token, expireAt);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 刷新Token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 刷新Token的时机： 当cacheToken已过期 并且Redis在有效期内
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 重新生成Token并覆盖Redis的v值(这时候k、v值不一样了)，然后设置Redis过期时间为：新Token过期时间
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">refreshToken</span>(String token, Claims claims) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 当前时间</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">long</span> current <span style="color:#f92672">=</span> System.<span style="color:#a6e22e">currentTimeMillis</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">/*
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         * 重新生成token
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">         */</span>
</span></span><span style="display:flex;"><span>        Calendar calendar <span style="color:#f92672">=</span> Calendar.<span style="color:#a6e22e">getInstance</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置签发时间</span>
</span></span><span style="display:flex;"><span>        calendar.<span style="color:#a6e22e">setTime</span>(<span style="color:#66d9ef">new</span> Date());
</span></span><span style="display:flex;"><span>        Date now <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 设置过期时间: 5分钟</span>
</span></span><span style="display:flex;"><span>        calendar.<span style="color:#a6e22e">add</span>(Calendar.<span style="color:#a6e22e">MINUTE</span>, 5);
</span></span><span style="display:flex;"><span>        Date time <span style="color:#f92672">=</span> calendar.<span style="color:#a6e22e">getTime</span>();
</span></span><span style="display:flex;"><span>        String refreshToken <span style="color:#f92672">=</span> Jwts.<span style="color:#a6e22e">builder</span>()
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setSubject</span>(claims.<span style="color:#a6e22e">getSubject</span>())
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 签发时间</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setIssuedAt</span>(now)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 过期时间</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">setExpiration</span>(time)
</span></span><span style="display:flex;"><span>                <span style="color:#75715e">// 算法与签名(同生成token)：这里算法采用HS512，常量中定义签名key</span>
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">signWith</span>(SignatureAlgorithm.<span style="color:#a6e22e">HS512</span>, ConstantKey.<span style="color:#a6e22e">SIGNING_KEY</span>)
</span></span><span style="display:flex;"><span>                .<span style="color:#a6e22e">compact</span>();
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 将refreshToken覆盖Redis的v值,并设置超时时间为refreshToken过期时间</span>
</span></span><span style="display:flex;"><span>        redisService.<span style="color:#a6e22e">set</span>(token, refreshToken, time);
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 打印日志</span>
</span></span><span style="display:flex;"><span>        log.<span style="color:#a6e22e">info</span>(<span style="color:#e6db74">&#34;刷新token执行时间: {}&#34;</span>, (System.<span style="color:#a6e22e">currentTimeMillis</span>() <span style="color:#f92672">-</span> current) <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; 毫秒&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><h5 id="6-修改-springsecurity-配置类注入-redisservice">6. 修改 <code>SpringSecurity</code> 配置类，注入 <code>RedisService</code>：</h5>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#a6e22e">@Configuration</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableWebSecurity</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableGlobalMethodSecurity</span>(securedEnabled <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SecurityConfig</span> <span style="color:#66d9ef">extends</span> WebSecurityConfigurerAdapter {
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> RedisService redisService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> UserDetailsService userDetailsService;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Resource</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">private</span> BCryptPasswordEncoder bCryptPasswordEncoder;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 全局请求忽略规则配置
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span>(WebSecurity web) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 需要放行的URL</span>
</span></span><span style="display:flex;"><span>        web.<span style="color:#a6e22e">ignoring</span>().<span style="color:#a6e22e">antMatchers</span>(<span style="color:#e6db74">&#34;/register&#34;</span>, <span style="color:#e6db74">&#34;/hello&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 自定义认证策略：登录的时候会进入
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span>(AuthenticationManagerBuilder auth) {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// 2. 通过实现 AuthenticationProvider 自定义身份认证验证组件</span>
</span></span><span style="display:flex;"><span>        auth.<span style="color:#a6e22e">authenticationProvider</span>(<span style="color:#66d9ef">new</span> AuthenticationProviderImpl(userDetailsService, bCryptPasswordEncoder));
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     * 自定义 HTTP 验证规则
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">     */</span>
</span></span><span style="display:flex;"><span>    <span style="color:#a6e22e">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">protected</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">configure</span>(HttpSecurity http) <span style="color:#66d9ef">throws</span> Exception {
</span></span><span style="display:flex;"><span>        http
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 关闭Session</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">sessionManagement</span>().<span style="color:#a6e22e">sessionCreationPolicy</span>(SessionCreationPolicy.<span style="color:#a6e22e">STATELESS</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 所有请求需要身份认证</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>().<span style="color:#a6e22e">authorizeRequests</span>().<span style="color:#a6e22e">anyRequest</span>().<span style="color:#a6e22e">authenticated</span>()
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 自定义JWT登录过滤器</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">addFilter</span>(<span style="color:#66d9ef">new</span> JwtLoginFilter(authenticationManager(), redisService))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 自定义JWT认证过滤器</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">addFilter</span>(<span style="color:#66d9ef">new</span> JwtAuthenticationFilter(authenticationManager(), redisService))
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 自定义认证拦截器，也可以直接使用内置实现类Http403ForbiddenEntryPoint</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">exceptionHandling</span>().<span style="color:#a6e22e">authenticationEntryPoint</span>(<span style="color:#66d9ef">new</span> AuthenticationEntryPointImpl())
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 允许跨域</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>().<span style="color:#a6e22e">cors</span>()
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// 禁用跨站伪造</span>
</span></span><span style="display:flex;"><span>            .<span style="color:#a6e22e">and</span>().<span style="color:#a6e22e">csrf</span>().<span style="color:#a6e22e">disable</span>();
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><blockquote>
<p>源码地址：<a href="https://github.com/chaooo/spring-security-jwt.git">https://github.com/chaooo/spring-security-jwt.git</a>,
这里我将本文的基于Redis的Token自动续签优化放在github源码tag的V2.0中，防止后续修改后代码对不上。</p>
</blockquote>

  
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></li>
        <li><a href="/tags/springsecurity/">SpringSecurity</a></li>
        <li><a href="/tags/%E5%AE%89%E5%85%A8%E8%AE%A4%E8%AF%81/">安全认证</a></li>
        <li><a href="/tags/token/">Token</a></li>
    </ul>
  </div>


  </main>
  <footer>
    <p>Copyright 2024. All rights reserved.</p>

  </footer>
</body>
</html>
