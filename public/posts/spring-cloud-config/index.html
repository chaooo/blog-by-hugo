<!DOCTYPE html>
<html lang="zh-TW" dir="ltr">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>「SpringCloud」Config配置中心 | My New Hugo Site！！！</title>

    <link rel="stylesheet" href="/css/main.css">


      <script src="/js/main.js"></script>


</head>
<body class="baseof">
  <header>
    <h1>My New Hugo Site！！！</h1>

  <nav>
    <ul>
    <li>
      <a href="/">首页</a>
    </li>
    <li>
      <a aria-current="true" class="ancestor" href="/posts/">列表</a>
    </li>
    <li>
      <a href="/tags/">标签</a>
    </li>
    </ul>
  </nav>


  </header>
  <main>
    
  <h1>最新文章 测试Single：「SpringCloud」Config配置中心</h1>

  
  
  <time datetime="2021-11-09T18:01:00&#43;00:00">November 9, 2021</time>

  <h3 id="1-spring-cloud-config简介">1. Spring Cloud Config简介</h3>
<p><code>Spring Cloud Config</code>可以为微服务架构中的应用提供集中化的外部配置支持，它分为服务端和客户端两个部分。
服务端被称为分布式配置中心，它是个独立的应用，可以从配置仓库获取配置信息并提供给客户端使用。
客户端可以通过配置中心来获取配置信息，在启动时加载配置。
<code>Spring Cloud Config</code>默认采用<code>Git</code>来存储配置信息，所以天然就支持配置信息的版本管理，并且可以使用<code>Git</code>客户端来方便地管理和访问配置信息。<!-- raw HTML omitted --></p>
<h3 id="2-准备工作">2. 准备工作</h3>
<p>因为<code>config server</code>是需要到<code>git</code>上拉取配置文件的，所以还需要在远程的<code>git</code>上新建一个存放配置文件的仓库，
如下仓库中存放客户端配置文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>application-beta.yml
</span></span><span style="display:flex;"><span>application-dev.yml
</span></span><span style="display:flex;"><span>application-prod.yml
</span></span></code></pre></div><h3 id="3-配置中心服务端搭建">3. 配置中心服务端搭建</h3>
<ol>
<li>搭建服务端配置中心（<code>config-server</code>），在<code>pom.xml</code>文件中添加依赖：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#75715e">&lt;!--配置服务--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-config-server<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">&lt;!--注册到注册中心--&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-netflix-eureka-client<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>在服务端编辑<code>application.yml</code>配置文件内容如下：</li>
</ol>
<pre tabindex="0"><code class="language-ymal" data-lang="ymal">server:
  port: 8009
# 指定当前服务的名称，这个名称会注册到注册中心
spring:
  application:
    name: config-server
  cloud:
    config:
      server:
        git: #配置存储配置信息的Git仓库
          uri: http://git.xxx.com/config-files.git # 远程git仓库的地址
          username: username                       # git账户名
          password: password                       # git密码
          clone-on-start: true                     # 开启启动时直接从git获取配置
          search-paths: /**                        # 指定搜索根路径下的目录，若有多个路径使用逗号隔开

# 指定服务注册中心的地址
eureka:
  instance:
    prefer-ip-address: true                                       # 是否使用 ip 地址注册
    instance-id: ${spring.cloud.client.ip-address}:${server.port} # ip:port
  client:
    service-url:                                                  # 设置服务注册中心地址
      defaultZone: http://localhost:18000/eureka/
</code></pre><ol start="3">
<li>在启动类上，加上<code>@EnableConfigServer</code>注解，声明这是一个<code>config-server</code>。代码如下：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#75715e">/**
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * `@EnableDiscoveryClient`: 声明一个可以被发现的客户端
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> * `@EnableConfigServer`: 声明一个Config配置服务
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableConfigServer</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@EnableDiscoveryClient</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">@SpringBootApplication</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ConfigApplication</span> {
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">main</span>(String<span style="color:#f92672">[]</span> args) {
</span></span><span style="display:flex;"><span>        SpringApplication.<span style="color:#a6e22e">run</span>(ConfigApplication.<span style="color:#a6e22e">class</span>, args);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><ol start="4">
<li>启动项目，访问<code>http://localhost:8009/master/application-dev.yml</code>，可以看到能够访问到客户端配置文件的内容。</li>
</ol>
<h3 id="4-客户端获取配置">4. 客户端获取配置</h3>
<ol>
<li>在<code>pom.xml</code>文件中添加依赖：</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-config<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.cloud<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;artifactId&gt;</span>spring-cloud-starter-bootstrap<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/dependency&gt;</span>
</span></span></code></pre></div><ol start="2">
<li>编辑<code>bootstrap.yml</code>配置文件内容如下：</li>
</ol>
<pre tabindex="0"><code class="language-ymal" data-lang="ymal">server:
  port: 18001

spring:
  cloud:
    config:            #Config客户端配置
      profile: dev                 #启用配置后缀名称
      label: master                #分支名称
      uri: http://localhost:8009   #配置中心地址
      name: application            #配置文件名称
</code></pre><p>启动服务，配置中心读取的配置生效。</p>
<h3 id="5-获取配置信息的基本规则">5. 获取配置信息的基本规则</h3>
<pre tabindex="0"><code># 获取配置信息
/{label}/{name}‐{profile}
# 获取配置文件信息
/{label}/{name}‐{profile}.yml
</code></pre><ul>
<li><code>name</code> : 文件名，一般以服务名(<code>spring.application.name</code>)来命名，如果配置了<code>spring.cloud.config.name</code>，则为该名称.</li>
<li><code>profiles</code> : 一般作为环境标识，对应配置文件中的<code>spring.cloud.config.profile</code></li>
<li><code>lable</code> : 分支（<code>branch</code>），指定访问某分支下的配置文件，对应配置文件中的<code>spring.cloud.config.label</code>，默认值是在服务器上设置的(对于基于<code>git</code>的服务器，通常是“<code>master</code>”)</li>
</ul>
<h4 id="51-maven的profile管理">5.1 Maven的Profile管理</h4>
<p><code>Maven</code>提供了<code>Profile</code>切换功能(多环境<code>dev,beta,prod</code>)， 如下<code>pom.xml</code>：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;profiles&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;profile&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;id&gt;</span>dev<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">&lt;!-- 环境标识，需要与配置文件的名称相对应 --&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;activatedProperties&gt;</span>dev<span style="color:#f92672">&lt;/activatedProperties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;activation&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">&lt;!-- 默认环境 --&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;activeByDefault&gt;</span>true<span style="color:#f92672">&lt;/activeByDefault&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/activation&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/profile&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;profile&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;id&gt;</span>beta<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;activatedProperties&gt;</span>beta<span style="color:#f92672">&lt;/activatedProperties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/profile&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;profile&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;id&gt;</span>prod<span style="color:#f92672">&lt;/id&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;properties&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;activatedProperties&gt;</span>prod<span style="color:#f92672">&lt;/activatedProperties&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/properties&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/profile&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/profiles&gt;</span>
</span></span></code></pre></div><p>配置文件<code>bootstrap.yml</code>：</p>
<pre tabindex="0"><code class="language-ymal" data-lang="ymal">spring:
  cloud:
    config:                             # Config客户端配置
      profile: @activatedProperties@    # 启用配置后缀名称
      label: master                     # 分支名称
      uri: http://localhost:8009        # 配置中心地址
      name: application                 # 配置文件名称
</code></pre><p><code>SpringBoot</code>一把情况下会遵从你选的环境将<code>@activatedProperties@</code>替换掉。</p>
<p>但<code>SpringCloud</code>比较特殊，使用配置中心后客户端不会再使用<code>application.yml</code>，而是使用<code>bootstrap.yml</code>。但是<code>Maven</code>不认<code>bootstrap.yml</code>里的<code>@activatedProperties@</code>。</p>
<p><strong>解决</strong>：在<code>pom.xml</code>的<code>build</code>标签里添加如下代码，用于过滤<code>yml</code>文件：</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#f92672">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;finalName&gt;</span>${project.artifactId}<span style="color:#f92672">&lt;/finalName&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;resources&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;resource&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;directory&gt;</span>src/main/resources<span style="color:#f92672">&lt;/directory&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">&lt;!--可以在此配置过滤文件  --&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;includes&gt;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">&lt;include&gt;</span>**/*.yml<span style="color:#f92672">&lt;/include&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;/includes&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">&lt;!--开启filtering功能  --&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;filtering&gt;</span>true<span style="color:#f92672">&lt;/filtering&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/resource&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/resources&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;groupId&gt;</span>org.springframework.boot<span style="color:#f92672">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">&lt;artifactId&gt;</span>spring-boot-maven-plugin<span style="color:#f92672">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;/build&gt;</span>
</span></span></code></pre></div><h4 id="52-将不同服务的配置文件放到以服务名命名的目录下">5.2 将不同服务的配置文件放到以服务名命名的目录下</h4>
<p>因为<code>config server</code>默认情况下只会搜索<code>git</code>仓库根路径下的配置文件，所以我们还需要加上一个配置项：<code>search-paths</code>，
该配置项用于指定<code>config server</code>搜索哪些路径下的配置文件，需要注意的是这个路径是相对于<code>git</code>仓库的，并非是项目的路径。</p>
<pre tabindex="0"><code>spring:
  cloud:
    config:
      server:
        git:
          ...
          search-paths: /**  # 指定搜索根路径下的所有目录，若有多个路径使用逗号隔开
</code></pre>
  
  <div>
    <div>Tags:</div>
    <ul>
        <li><a href="/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/">后端开发</a></li>
        <li><a href="/tags/springcloud/">SpringCloud</a></li>
        <li><a href="/tags/config/">Config</a></li>
    </ul>
  </div>


  </main>
  <footer>
    <p>Copyright 2024. All rights reserved.</p>

  </footer>
</body>
</html>
